# =============================================================================
# SRC - MAKEFILE OP√âRATIONNEL (FARDC SIGINT SYSTEM)
# =============================================================================

# Chemins
SCRIPTS_DIR = scripts
DEPLOY_SCRIPT = infra/deployment/deploy_field.sh
BUILD_DIR = build
BIN = $(BUILD_DIR)/sigint-engine

.PHONY: all build harden deploy test rotate-keys clean-logs check-integrity help

all: build harden test

# --- [ PHASE 1 : CONSTRUCTION ] ---
build:
	@echo "üõ†Ô∏è  Compilation du syst√®me SRC..."
	@mkdir -p build
	kotlinc src/Main.kt core/**/*.kt bft/**/*.kt services/**/*.kt ui/**/*.kt -include-runtime -d build/sigint-engine.jar

# --- [ PHASE 2 : S√âCURISATION ] ---
harden:
	@echo "üõ°Ô∏è  D√©marrage du durcissement tactique..."
	@bash $(SCRIPTS_DIR)/harden_binary.sh
	@# Sauvegarde de la signature pour integrity_check
	@sha256sum $(BIN) | cut -d ' ' -f1 > specs/integrity_signature.txt
	@echo "[OK] Binaire obscurci et signature d'int√©grit√© g√©n√©r√©e."

rotate-keys:
	@bash $(SCRIPTS_DIR)/rotate_keys.sh

# --- [ PHASE 3 : VALIDATION ] ---
test:
	@echo "üß™ Lancement de la suite de tests d'int√©gration..."
	@bash $(SCRIPTS_DIR)/run_tests.sh

check-integrity:
	@bash $(SCRIPTS_DIR)/integrity_check.sh

# --- [ PHASE 4 : D√âPLOIEMENT ] ---
deploy:
	@echo "üöÄ D√©ploiement sur terminal de combat..."
	@bash $(DEPLOY_SCRIPT) --zone KIVU_NORD --unit_id ALPHA-01

# --- [ UTILS ] ---
clean-logs:
	@bash $(SCRIPTS_DIR)/clean_logs.sh

clean:
	@echo "üßπ Nettoyage de l'espace de travail..."
	@rm -rf $(BUILD_DIR)
	@echo "[OK] Dossier build supprim√©."

help:
	@echo "Usage : make [CIBLE]"
	@echo "  build            : Compile le binaire SIGINT"
	@echo "  harden           : Obscurcit le binaire et g√©n√®re la signature"
	@echo "  test             : Lance les tests de la cha√Æne OODA"
	@echo "  deploy           : Pr√©pare l'appareil pour le terrain"
	@echo "  rotate-keys      : G√©n√®re de nouvelles cl√©s master/session"
	@echo "  check-integrity  : V√©rifie si le binaire a √©t√© alt√©r√©"

